<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Ausschüttungsverwaltung</title>
  <style>
    body { font-family: Arial, sans-serif; background: #eef5fc; }
    .container { width: 90%; margin: auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 8px; border-bottom: 1px solid #ddd; }
    th { background: #4a8fcf; color: white; }
    .green { color: green; }
    .red { color: red; }
    select, button { padding: 6px; margin: 5px 0; }
  </style>
</head>
<body>
<div class="container">
  <h2>Ausschüttungsverwaltung</h2>
  Gesellschaft:
  <select id="komplementaer">
    <option value="">--Auswählen--</option>
  </select>
  <button onclick="exportCSV()">Export CSV</button>
  <table id="table">
    <thead>
      <tr><th>Jahr</th><th>Geplant (%)</th><th>Ist (%)</th><th>Auszahlung</th><th>Δ</th></tr>
    </thead>
    <tbody id="data"></tbody>
    <tfoot><tr><td>Summe</td><td id="sumSoll">0</td><td id="sumIst">0</td><td colspan="2"></td></tr></tfoot>
  </table>
</div>
<script>
  const sel = document.getElementById('komplementaer');
  fetch('/api/komplementaere').then(r=>r.json()).then(d=> {
    d.forEach(k=> sel.innerHTML+=`<option>${k}</option>`);
  });

  sel.onchange=()=>{
    fetch('/api/ausschuettungen/'+sel.value).then(r=>r.json()).then(d=> {
      let html='', sumSoll=0, sumIst=0;
      d.forEach(i=>{
        const diff=i.Ausschuettung-i.AusschuettungSoll;
        sumSoll+=i.AusschuettungSoll;
        sumIst+=i.Ausschuettung;
        const farbe=diff>=0?'green':'red';
        html+=`<tr>
          <td>${i.Jahr}</td>
          <td>${i.AusschuettungSoll}</td>
          <td>${i.Ausschuettung}</td>
          <td>${new Date(i.Auszahlung).toLocaleDateString('de-DE')}</td>
          <td class="${farbe}">${diff}</td>
        </tr>`;
      });
      document.getElementById('data').innerHTML=html;
      document.getElementById('sumSoll').innerText=sumSoll;
      document.getElementById('sumIst').innerText=sumIst;
    });
  };

  function exportCSV(){
    const rows=[["Jahr","Geplant","Ist","Auszahlung","Differenz"]];
    document.querySelectorAll("#data tr").forEach(tr=>{
      const row=[];
      tr.querySelectorAll("td").forEach(td=>row.push(td.innerText));
      rows.push(row);
    });
    let csv=rows.map(e=>e.join(";")).join("\n");
    let blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
    let url=URL.createObjectURL(blob);
    let a=document.createElement("a");
    a.href=url;
    a.download="ausschuettungen.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
</script>
</body>
</html>
