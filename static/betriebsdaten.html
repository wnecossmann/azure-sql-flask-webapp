<!-- betriebsdaten.html -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Betriebsdatenerfassung</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #e9edf5; margin: 0; }
    .card { max-width: 1200px; margin: 2em auto; background: rgba(255,255,255,0.9); box-shadow: 0 8px 24px #b2bedf30; border-radius: 20px; padding: 2em;}
    h2 { font-size: 2rem; text-align: center; }
    label, select, input { font-size: 1em; }
    form { display: flex; gap: 1em; flex-wrap: wrap; margin-bottom: 2em; align-items: center;}
    input, select { border: 1px solid #b2bedf; border-radius: 8px; padding: .3em .8em; background: #f9faff;}
    button { border: none; background: #5376e6; color: white; border-radius: 8px; padding: .5em 1.2em; cursor: pointer; font-weight: 600;}
    table { width: 100%; border-collapse: collapse; margin-top: 1em;}
    th, td { padding: .4em .6em; }
    th { background: #5376e6; color: white; }
    tr:nth-child(even) { background: #f4f7fc; }
    .summe { font-weight: bold; background: #d8e4ff;}
    @media (max-width: 1000px) {
      .card, table, th, td { font-size: 0.95em; padding: .2em; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Betriebsdatenerfassung</h2>
    <form id="filterForm">
      <label for="jahr">Jahr:</label>
      <input type="number" id="jahr" min="2000" max="2100" value="2025">
      <label for="monat">Monat:</label>
      <select id="monat">
        <option>März</option>
        <option>Januar</option>
        <option>Februar</option>
        <option>April</option>
        <option>Mai</option>
        <option>Juni</option>
        <option>Juli</option>
        <option>August</option>
        <option>September</option>
        <option>Oktober</option>
        <option>November</option>
        <option>Dezember</option>
      </select>
      <button type="button" onclick="ladeTabelle()">Anzeigen</button>
    </form>
    <form id="bdeForm">
      <select id="weaSel"></select>
      <input type="number" id="anlagenMessung" placeholder="Anlagenmessung" required>
      <input type="number" id="geichteteMessung" placeholder="Geichtete Messung" required>
      <input type="number" id="verfuegbarkeit" step="0.001" min="0" max="1" placeholder="Verfügbarkeit" required>
      <input type="number" id="windmittel" step="0.01" placeholder="Windmittel" required>
      <input type="text" id="bemerkungen" placeholder="Bemerkungen">
      <button>Speichern</button>
    </form>
    <table id="bdTabelle">
      <thead>
        <tr>
          <th>Anlage</th>
          <th>Jahr</th>
          <th>Monat</th>
          <th>Anlagenmessung</th>
          <th>Geichtete Messung</th>
          <th>Verfügbarkeit</th>
          <th>Windmittel</th>
          <th>Bemerkungen</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr class="summe">
          <td colspan="3">Summe</td>
          <td id="sumAnlagen"></td>
          <td id="sumGeichtete"></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>
<script>
async function ladeWEAs() {
  let res = await fetch('/api/weas'); let weas = await res.json();
  let sel = document.getElementById('weaSel');
  sel.innerHTML = weas.map(w => `<option value="${w.WEAID}">${w.Bez || w.Bezeichnung}</option>`).join('');
}
async function ladeTabelle() {
  let jahr = document.getElementById('jahr').value;
  let monat = document.getElementById('monat').value;
  let res = await fetch(`/api/betriebsdaten/${jahr}/${monat}`); let daten = await res.json();
  let tbody = document.querySelector('#bdTabelle tbody');
  let sumAnlagen = 0, sumGeichtete = 0;
  tbody.innerHTML = daten.map(row => {
    sumAnlagen += Number(row.AnlagenMessung || 0);
    sumGeichtete += Number(row.geichteteMessung || 0);
    return `<tr>
      <td>${row.Bez || ''}</td>
      <td>${row.Jahr || ''}</td>
      <td>${row.Monat || ''}</td>
      <td>${row.AnlagenMessung ? row.AnlagenMessung.toLocaleString('de-DE') : ''}</td>
      <td>${row.geichteteMessung ? row.geichteteMessung.toLocaleString('de-DE') : ''}</td>
      <td>${row.Verfuegbarkeit ? row.Verfuegbarkeit.toLocaleString('de-DE', {minimumFractionDigits:3}) : ''}</td>
      <td>${row.Windmittel ? row.Windmittel.toLocaleString('de-DE', {minimumFractionDigits:1}) : ''}</td>
      <td>${row.Bemerkungen || ''}</td>
    </tr>`;
  }).join('');
  document.getElementById('sumAnlagen').textContent = sumAnlagen.toLocaleString('de-DE');
  document.getElementById('sumGeichtete').textContent = sumGeichtete.toLocaleString('de-DE');
}
document.getElementById('bdeForm').onsubmit = async e => {
  e.preventDefault();
  let jahr = document.getElementById('jahr').value;
  let monat = document.getElementById('monat').value;
  let body = {
    WEAID: document.getElementById('weaSel').value,
    Jahr: jahr,
    Monat: monat,
    AnlagenMessung: document.getElementById('anlagenMessung').value,
    geichteteMessung: document.getElementById('geichteteMessung').value,
    Verfuegbarkeit: document.getElementById('verfuegbarkeit').value,
    Windmittel: document.getElementById('windmittel').value,
    Bemerkungen: document.getElementById('bemerkungen').value
  };
  await fetch('/api/betriebsdaten', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  ladeTabelle();
};
ladeWEAs();
ladeTabelle();
</script>
</body>
</html>
