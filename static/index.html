<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Personenverwaltung Azure SQL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body { font-family: 'Segoe UI', Arial; background: #f4f7fa; margin:0; padding:20px;}
      .container { max-width:1200px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.1);}
      table {width:100%; border-collapse:collapse;}
      th, td {padding:8px; border-bottom:1px solid #ddd;}
      th {background:#4978b8; color:#fff;}
      tr:hover {background:#f0f8ff;}
      input {width:95%; padding:4px;}
      button {padding:4px 10px; cursor:pointer;}
    </style>
</head>
<body>
<div class="container">
  <h2>Personenverwaltung</h2>
  <table>
    <thead>
      <tr>
        <th>Name</th><th>Vorname</th><th>Geburtstag</th><th>Beruf</th><th>Mail</th><th>Telefon</th><th>Straße</th><th>PLZ</th><th>Ort</th><th></th>
      </tr>
    </thead>
    <tbody id="daten"></tbody>
  </table>
</div>
<script>
  function sqlDateToDE(d){
    const date = new Date(d);
    return `${String(date.getDate()).padStart(2,'0')}.${String(date.getMonth()+1).padStart(2,'0')}.${date.getFullYear()}`;
  }
  function deToSQLDate(d){
    const [day, month, year]=d.split('.');
    return `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
  }
  fetch('/api/daten').then(r=>r.json()).then(data=>{
    const tbody=document.getElementById('daten');
    data.forEach(r=>{
      const tr=document.createElement('tr');
      ['Name','Vorname','Geburtstag','Beruf','Mail','Telefon','Straße','PLZ','Ort'].forEach((f,i)=>{
        const td=document.createElement('td');
        const inp=document.createElement('input');
        inp.value=f==='Geburtstag'?sqlDateToDE(r[f]):(r[f]??'');
        td.appendChild(inp);
        tr.appendChild(td);
      });
      const tdBtn=document.createElement('td');
      const btn=document.createElement('button');
      btn.textContent='Speichern';
      btn.onclick=async()=>{
        btn.disabled=true;
        const inputs=tr.querySelectorAll('input');
        const payload={PersonID:r.PersonID};
        ['Name','Vorname','Geburtstag','Beruf','Mail','Telefon','Straße','PLZ','Ort'].forEach((f,i)=>{
          payload[f]=f==='Geburtstag'?deToSQLDate(inputs[i].value):inputs[i].value;
        });
        const resp=await fetch('/api/update_person',{
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
        });
        const result=await resp.json();
        btn.disabled=false;
        alert(result.status==='success'?'Gespeichert!':'Fehler: '+result.error);
      };
      tdBtn.appendChild(btn); tr.appendChild(tdBtn); tbody.appendChild(tr);
    });
  });
</script>
</body>
</html>
