<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Betriebsdatenerfassung</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background: #eef2fb;
            font-family: 'Segoe UI', sans-serif;
        }
        .container {
            max-width: 700px;
            margin: 40px auto;
            padding: 2rem;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 8px 32px 0 rgba(31,38,135,0.2);
            border-radius: 24px;
            backdrop-filter: blur(9px);
        }
        h1 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #2b3674;
        }
        .row { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;}
        select, input, textarea, button {
            border: none;
            border-radius: 10px;
            padding: 0.5em 1em;
            font-size: 1rem;
            background: rgba(240,240,255,0.65);
            box-shadow: 0 2px 10px rgba(80,80,150,0.06);
            transition: box-shadow 0.2s;
        }
        select:focus, input:focus, textarea:focus {
            outline: 2px solid #6c8ddb;
        }
        label { font-size: 1rem; color: #4a569d;}
        button {
            background: linear-gradient(90deg,#6c8ddb,#8cb6fc);
            color: white; font-weight: bold; cursor: pointer;
            box-shadow: 0 3px 10px rgba(80,80,150,0.13);
            transition: background 0.2s;
        }
        button:hover { background: linear-gradient(90deg,#557fd8,#70a5fb);}
        .status { margin-top: 1.5rem; text-align: center;}
        .success { color: #22953b; }
        .error { color: #d41e4f; }
        .field-group { flex: 1; min-width: 170px;}
        @media (max-width: 600px) {
            .container { padding: 0.8rem; }
            .row { flex-direction: column; gap: 0.8rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Betriebsdatenerfassung</h1>
        <div class="row">
            <div class="field-group">
                <label for="standort">Standort</label><br>
                <select id="standort"></select>
            </div>
            <div class="field-group">
                <label for="jahr">Jahr</label><br>
                <select id="jahr"></select>
            </div>
            <div class="field-group">
                <label for="monat">Monat</label><br>
                <select id="monat"></select>
            </div>
        </div>
        <form id="bdewea-form">
            <div class="row">
                <div class="field-group">
                    <label for="anlagen">Anlagenmessung</label><br>
                    <input id="anlagen" name="AnlagenMessung" type="number" step="any" required>
                </div>
                <div class="field-group">
                    <label for="geeicht">Geeichte Messung</label><br>
                    <input id="geeicht" name="geeichteMessung" type="number" step="any">
                </div>
            </div>
            <div class="row">
                <div class="field-group">
                    <label for="verfueg">Verfügbarkeit (%)</label><br>
                    <input id="verfueg" name="Verfügbarkeit" type="number" step="any">
                </div>
                <div class="field-group">
                    <label for="windmittel">Windmittel</label><br>
                    <input id="windmittel" name="Windmittel" type="number" step="any">
                </div>
            </div>
            <div class="row">
                <div class="field-group" style="flex:2">
                    <label for="bemerk">Bemerkungen</label><br>
                    <textarea id="bemerk" name="Bemerkungen" rows="2" style="width: 100%;"></textarea>
                </div>
            </div>
            <div class="row" style="justify-content:center;">
                <button type="submit" id="save-btn">Speichern</button>
            </div>
        </form>
        <div class="status" id="status"></div>
    </div>

    <script>
        const standortSel = document.getElementById('standort');
        const jahrSel = document.getElementById('jahr');
        const monatSel = document.getElementById('monat');
        const statusDiv = document.getElementById('status');
        const form = document.getElementById('bdewea-form');

        let aktuelleIDs = {};

        async function loadDropdown(api, selectEl, field="Bezeichnung") {
            const res = await fetch(api);
            const data = await res.json();
            selectEl.innerHTML = "";
            for(const d of data){
                let txt = d[field] || d["Monat"] || d["Jahr"];
                let val = d[Object.keys(d)[0]];
                let opt = document.createElement("option");
                opt.value = val; opt.textContent = txt;
                selectEl.appendChild(opt);
            }
        }

        async function vorbefuellen() {
            const standort_id = standortSel.value, jahr_id = jahrSel.value, monat_id = monatSel.value;
            if(!standort_id || !jahr_id || !monat_id) return;
            aktuelleIDs = {standort_id, jahr_id, monat_id};
            // Hole existierende Werte für diese Kombination (optional: /api/bdewea?standort_id=...&jahr_id=...&monat_id=...)
            const resp = await fetch(`/api/bdewea?standort_id=${standort_id}&jahr_id=${jahr_id}&monat_id=${monat_id}`);
            const daten = await resp.json();
            if(daten.length>0) {
                // Annahme: Für diesen Standort/Monat gibt es nur einen Eintrag (sonst ggf. erweitern)
                const d = daten[0];
                form.AnlagenMessung.value = d.AnlagenMessung ?? "";
                form.geeichteMessung.value = d.geeichteMessung ?? "";
                form['Verfügbarkeit'].value = d.Verfügbarkeit ?? "";
                form.Windmittel.value = d.Windmittel ?? "";
                form.Bemerkungen.value = d.Bemerkungen ?? "";
                aktuelleIDs.BDEID = d.BDEID;
            } else {
                form.reset();
                aktuelleIDs.BDEID = undefined;
            }
            statusDiv.textContent = "";
        }

        async function speichern(e){
            e.preventDefault();
            const
