<!-- Datei: bdewea.html -->
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Betriebsdaten je WEA</title>
    <style>
        body { background:#eef2fb; font-family:Segoe UI,sans-serif;}
        .container { max-width:700px; margin:60px auto; background:rgba(255,255,255,0.85); border-radius:24px; box-shadow:0 8px 32px 0 rgba(31,38,135,.17);padding:2em;}
        h1 { text-align:center; color:#243571;}
        label { font-weight:bold; color:#435099;}
        select,input,textarea,button {width:100%;padding:.5em;margin-bottom:1em;border-radius:10px;border:none;background:rgba(240,240,255,0.7);}
        button { background:#728eea; color:#fff;font-weight:bold; cursor:pointer; }
        button:hover { background:#4f71c7;}
        .msg{margin-top:1em;text-align:center;}
        .success{color:#1d872a;}
        .error{color:#d12b40;}
    </style>
</head>
<body>
    <div class="container">
        <h1>Betriebsdaten je WEA</h1>
        <form id="form-wea">
            <label>Standort</label>
            <select id="standort"></select>
            <label>WEA</label>
            <select id="wea"></select>
            <label>Jahr</label>
            <select id="jahr"></select>
            <label>Monat</label>
            <select id="monat"></select>
            <label>Anlagenmessung</label>
            <input id="anlagen" type="number" step="any" min="0" required>
            <label>Geeichte Messung</label>
            <input id="geeicht" type="number" step="any" min="0">
            <label>Verfügbarkeit (%)</label>
            <input id="verfueg" type="number" step="any">
            <label>Windmittel</label>
            <input id="windmittel" type="number" step="any">
            <label>Bemerkungen</label>
            <textarea id="bemerk"></textarea>
            <button type="submit">Speichern</button>
        </form>
        <div id="msg" class="msg"></div>
    </div>
    <script>
    // Funktion mit zusätzlichem valKey-Parameter!
    async function fetchOpts(api, sel, txtKey, valKey) {
        const d = await fetch(api).then(r=>r.json());
        sel.innerHTML = ""; 
        d.forEach(v=>{
            const o=document.createElement("option");
            o.value = valKey ? v[valKey] : v[Object.keys(v)[0]];
            o.textContent = txtKey ? v[txtKey] : v[Object.keys(v)[1]];
            sel.appendChild(o);
        });
    }
    const standortSel=document.getElementById('standort'),
          weaSel=document.getElementById('wea'),
          jahrSel=document.getElementById('jahr'),
          monatSel=document.getElementById('monat'),
          msgDiv=document.getElementById('msg');
    (async()=>{
        await fetchOpts('/api/standorte', standortSel, "Bezeichnung", "StandortID");
        await fetchOpts('/api/jahre', jahrSel, "Jahr", "JahrID");
        await fetchOpts('/api/monate', monatSel, "Monat", "MonatID");
        standortSel.onchange = async()=>{
            await fetchOpts('/api/weas/'+standortSel.value, weaSel, "Bezeichnung", "WEAID");
        }
        // Initial einmal auslösen (falls beim Laden ein Standort vorausgewählt ist)
        standortSel.onchange();
    })();
    document.getElementById('form-wea').onsubmit=async(e)=>{
        e.preventDefault();
        const body = {
            WEAID: weaSel.value, JahrID: jahrSel.value, MonatID: monatSel.value,
            AnlagenMessung: anlagen.value, geeichteMessung: geeicht.value,
            Verfügbarkeit: verfueg.value, Windmittel: windmittel.value, Bemerkungen: bemerk.value
        };
        const resp = await fetch('/api/bdewea', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(body)
        });
        const res = await resp.json();
        msgDiv.textContent = res.status==="success" ? "Gespeichert!" : "Fehler: "+(res.error||"");
        msgDiv.className = "msg "+(res.status==="success" ? "success" : "error");
    }
    </script>
</body>
</html>
